<!DOCTYPE html>
<html>
<head>
    <title>Singing Hollow - Sebastian Adams</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            overflow: hidden;
            font-family: "Open Sans", Arial, sans-serif;
            font-optical-sizing: auto;
            font-weight: 300;
            font-style: normal;
        }
        .video-container {
            position: absolute;
            opacity: 0.8;
            transition: opacity 1s ease-in-out;
        }
        video {
            opacity: 0.8;
        }
        .bottom-link {
            position: fixed;
            bottom: 10px;
            color: white;
            text-decoration: none;
            font-family: sans-serif;
            z-index: 101;
        }
        .bottom-link:hover {
            color: green;
        }
        #reload-link {
            left: 10px;
        }
        .home-link {
            right: 10px;
        }
        .sebastian-link {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        ul {
            list-style-type: none;
            padding: 0;
            margin: 20px 0;
        }
        .buttonlink, buttonlink:visited {
            font-size: 1.2em;
            padding: 10px;
            color: black;
            text-decoration: none;
            background-color: rgb(153, 153, 153);
        }
        .buttonlink:hover {
            background-color: rgb(0, 241, 108);
        }
        #play-sound-button {
            background-color: rgb(190, 190, 190);
        }
        #play-sound-button:hover {
            background-color: rgb(16, 241, 0);
        }
        #intro {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            padding: 20px;
            z-index: 102;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(55, 55, 55, 0.354);
            background: linear-gradient(to right, transparent, 10%, rgba(55, 55, 55, 0.487), 90%, transparent);
        }
        .button-container {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        #bell-notation-container {
            position: fixed;
            top: 0;
            width: 30%;
            height: 100vh;
            color: white;
            overflow: hidden;
            box-sizing: border-box;
            z-index: 100;
            display: flex;
            flex-direction: column;
            text-align: center;
        }
        .bell-line {
            font-family: monospace;
            font-size: 2.5em;
            white-space: pre;
            line-height: 1.2;
            height: 1.2em;
        }
        .bell-digit {
            opacity: 0.4;
            transition: opacity 0.1s ease-in-out;
            display: inline-block;
            width: 1em;
        }
        .bell-digit.active {
            opacity: 1;
        }

        @media (orientation: portrait) {
            body.portrait {
                transform: rotate(90deg);
                transform-origin: center center;
                width: 100vh;
                height: 100vw;
                overflow-x: hidden;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(90deg);
            }
            body.portrait .bottom-link {
                bottom: 20px;
                top: auto;
                width: auto;
            }
            body.portrait #reload-link {
                left: 10%;
            }
            body.portrait .home-link {
                right: 10%;
            }
            body.portrait .sebastian-link {
                left: 50%;
                transform: translateX(-50%);
                display: block;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div id="bell-notation-container">
        <div id="bell-notation-display"></div>
    </div>
    <div id="video-players"></div>
    <a href="score.html" class="home-link bottom-link">SCORE</a>
    <a href="#" id="reload-link" class="reload-link bottom-link">RELOAD</a>

    <div id="intro">
        <h2>Singing Hollow</h2>
        <h3>A performance installation for church bells (method ringers), organ, and walking instruments. Designed around St Audoen's Church, Dublin.</h3>
        <div class="button-container">
            <a id="about-button" class="buttonlink" href="audience.html">About</a>
            <a id="play-sound-button" class="buttonlink" href="#">PLAY</a>
            <a id="score-button" class="buttonlink" href="score.html">Score</a>
        </div>
        <ul>
            <li>organ - Olesia Borsuk</li>
            <li>saxophone - Nick Roth</li>
            <li>viola - Joanna Mattrey</li>
            <li>melodica - Robert Coleman</li>
            <li>shakuhachi - Jin Theriault</li>
            <li>composition/walkie talkie/web design - Sebastian Adams</li>
            <li>the bell-ringers of St Audoenâ€™s Church, Dublin</li>
            <br>
            <li>commissioned by the OPW/The Liberties Festival</li>
            <br>
            <li>video footage shot by Paul Scully</li>
        </ul>
    </div>

    <script>
        // --- CONFIGURATION ---
        const ENABLE_SPATIAL_AUDIO = true; // false to disable position-based pan and volume
        const VIDEO_SIZE = 1.8; // size of videos = smallest dimension/this const
        const videoFiles = [
            "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230408_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230409_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230410_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230411_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230412_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230413_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230414_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230415_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230416_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230417_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230418_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230419_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230420_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230421_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230422_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230423_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230424_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230425_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230426_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230427_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230428_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230429_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230430_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230431_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230432_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230433_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230434_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230435_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230436_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230437_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230438_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230439_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230440_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230441_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230442_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230443_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230444_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230445_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230446_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230447_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230448_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230449_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230450_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230451_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230452_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230453_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230454_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230455_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230456_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230457_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230458_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230459_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230460_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230461_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230462_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230463_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230464_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230465_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230466_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230467_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230468_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230469_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230470_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230471_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230472_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230473_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230474_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230475_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230476_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230477_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230478_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230479_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230480_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230481_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230482_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230483_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230484_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230485_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230486_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230487_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230488_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230489_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230490_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230491_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230492_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230493_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230494_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/P1230495_crf28.mp4", "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/123_PANA/unprocessed"
        ];
        const audioFile = "https://media.githubusercontent.com/media/sebastianadams-music/singing_hollow/main/SEB_BELLS_PIECE_JULY25/audio/output.m4a";
        const maxVideos = 4;
        const videoPlayersContainer = document.getElementById('video-players');
        const playSoundButton = document.getElementById('play-sound-button');
        const introElements = document.getElementById('intro');
        const reloadLink = document.getElementById('reload-link');
        let videoPlayers = [];
        let audio;
        let isInitialLoad = true;
        let audioCtx;

        // Bell Notation Variables
        const plainHunt6 = [
            "123456", "214365", "241635", "426153", "462513", "645231",
            "654321", "563412", "536142", "351624", "315246", "132564"
        ];
        const fibonacciSequence = [1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987];
        let fibonacciIndex = 0;
        const baseBellSpeed = 1000; // time-step size in mx
        const maxBellDisplayLines = 10;
        let currentLineIndex = 0;
        let currentDigitIndex = 0;
        let leadCount = 0;
        let bellAnimationTimeout;
        let currentActiveDigitElement = null;

        const bellNotationContainer = document.getElementById('bell-notation-container');
        const bellNotationDisplay = document.getElementById('bell-notation-display');

        function getRandomVideo() {
            return videoFiles[Math.floor(Math.random() * videoFiles.length)];
        }

        // --- AUDIO HELPERS ---
        function initVideoAudioNodes(videoEl) {
            if (!audioCtx) return null;
            if (videoEl._pannerNode) return videoEl._pannerNode;

            const source = audioCtx.createMediaElementSource(videoEl);
            const panner = audioCtx.createStereoPanner();
            
            source.connect(panner);
            panner.connect(audioCtx.destination);
            
            videoEl._pannerNode = panner;
            videoEl._sourceNode = source;
            return panner;
        }

        function updateSpatialAudio(videoEl, styleLeft, styleTop, containerW, containerH) {
            if (!ENABLE_SPATIAL_AUDIO) {
                videoEl.volume = 1.0;
                if (videoEl._pannerNode) videoEl._pannerNode.pan.value = 0;
                return;
            }

            const isPortrait = document.body.classList.contains('portrait');
            const vWidth = videoEl.width || 300;
            const vHeight = vWidth * (9/16);

            // Calculate Center based on the style positions (relative to the container)
            const centerX = styleLeft + (vWidth / 2);
            const centerY = styleTop + (vHeight / 2);

            let panVal = 0;
            let volVal = 1;

            if (isPortrait) {
                // IN PORTRAIT MODE (Body is rotated 90deg clockwise)
                // 'styleLeft' runs along the LONG edge (Visual Vertical)
                // 'styleTop' runs along the SHORT edge (Visual Horizontal)
                
                // 1. Panning (Left/Right) is determined by 'styleTop'
                //    0 (Top) is visual Right, Max (Bottom) is visual Left.
                //    We need to map styleTop 0..containerH to 1..-1 (Right to Left)
                
                // Normalize Top position (0 to 1)
                const normH = centerY / containerH; 
                // Map to Pan: 0 -> +1 (Right), 1 -> -1 (Left)
                panVal = (1 - normH * 2) * 0.66; // * 0.66 for 2/3rds width

                // 2. Volume (Top/Bottom) is determined by 'styleLeft'
                //    0 (Left) is visual Top, Max (Right) is visual Bottom.
                const normV = centerX / containerW;
                const distFromCenter = Math.abs(normV - 0.5);
                volVal = 1.0 - distFromCenter;

            } else {
                // STANDARD MODE
                // 'styleLeft' is Horizontal (Pan)
                // 'styleTop' is Vertical (Volume)
                
                const normH = centerX / containerW;
                panVal = (normH * 2 - 1) * 0.66;

                const normV = centerY / containerH;
                const distFromCenter = Math.abs(normV - 0.5);
                volVal = 1.0 - distFromCenter;
            }

            // Clamp values
            panVal = Math.max(-0.9, Math.min(0.9, panVal));
            volVal = Math.max(0, Math.min(1, volVal));

            if (audioCtx && !videoEl._pannerNode) {
                initVideoAudioNodes(videoEl);
            }
            if (videoEl._pannerNode) {
                videoEl._pannerNode.pan.value = panVal;
            }
            videoEl.volume = volVal;
        }

        // --- POSITIONING LOGIC ---
        function setRandomPosition(container, video) {
            const isPortrait = document.body.classList.contains('portrait');
            
            // Define limits based on rotation
            let limitX, limitY;
            
            if (isPortrait) {
                // In portrait, the body is 100vh wide and 100vw high.
                // We use visualViewport if available for accuracy, else fallback
                limitX = (window.visualViewport ? window.visualViewport.height : window.innerHeight); // Body Width (Screen Height)
                limitY = (window.visualViewport ? window.visualViewport.width : window.innerWidth);   // Body Height (Screen Width)
            } else {
                limitX = window.innerWidth;
                limitY = window.innerHeight;
            }

            // Calculate video dimensions (assuming aspect ratio)
            const vWidth = video.width;
            const vHeight = vWidth * (9 / 16);

            // Add a safety margin (5%) so videos don't touch the absolute edge
            const marginX = limitX * 0.05;
            const marginY = limitY * 0.05;

            // Random positions within safe area
            // Note: In portrait, 'randLeft' is the Vertical axis, 'randTop' is Horizontal
            const randLeft = marginX + Math.random() * (limitX - vWidth - (marginX * 2));
            const randTop = marginY + Math.random() * (limitY - vHeight - (marginY * 2));

            container.style.left = randLeft + 'px';
            container.style.top = randTop + 'px';

            // Pass these exact limits to audio updater so it knows the scale
            updateSpatialAudio(video, randLeft, randTop, limitX, limitY);
        }

        function createVideoPlayer() {
            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-container';

            const video = document.createElement('video');
            video.src = getRandomVideo();
            video.autoplay = false;
            video.muted = false;
            video.crossOrigin = "anonymous";
            
            // Set basic width (relative to the smaller screen dimension for consistency)
            const minDim = Math.min(window.innerWidth, window.innerHeight);
            video.width = minDim / VIDEO_SIZE 

            // Initial Position
            setRandomPosition(videoContainer, video);

            video.onended = () => handleVideoEnd(videoContainer, video);
            
            video.onplay = () => {
                if (!isInitialLoad) {
                    videoContainer.style.opacity = 0.8;
                }
                const fadeOutTimeout = (video.duration - 1) * 1000;
                if (fadeOutTimeout > 0) {
                    setTimeout(() => {
                        videoContainer.style.opacity = 0;
                    }, fadeOutTimeout);
                }
            };

            videoContainer.appendChild(video);
            videoPlayersContainer.appendChild(videoContainer);
            videoPlayers.push({ container: videoContainer, video: video });
        }

        function handleVideoEnd(container, video) {
            container.style.opacity = 0;
            // 50% chance of going straight on or else waits for a random time before picking next video
            if (Math.random() < 0.5) {
                setTimeout(() => {
                    video.src = getRandomVideo();
                    setRandomPosition(container, video); // Re-randomize
                    video.play();
                }, 1000);
            } else {
                container.style.display = 'none';
                setTimeout(() => {
                    video.src = getRandomVideo();
                    container.style.display = 'block';
                    setRandomPosition(container, video); // Re-randomize
                    video.play();
                }, Math.random() * 75000);
            }
        }

        function setupAudio() {
            audio = new Audio(audioFile);
            audio.loop = true;
            audio.volume = 0.5;
            audio.addEventListener('canplaythrough', () => {
                const randomStartTime = Math.random() * audio.duration;
                audio.currentTime = randomStartTime;
            });
        }

        function initBellNotation() {
            for (let i = 0; i < maxBellDisplayLines - 1; i++) {
                const lineDiv = document.createElement('div');
                lineDiv.classList.add('bell-line');
                const lineContent = plainHunt6[i % plainHunt6.length];
                for (const digit of lineContent) {
                    const digitSpan = document.createElement('span');
                    digitSpan.classList.add('bell-digit');
                    digitSpan.textContent = digit;
                    lineDiv.appendChild(digitSpan);
                }
                bellNotationDisplay.appendChild(lineDiv);
            }
            currentLineIndex = (maxBellDisplayLines - 1) % plainHunt6.length;
        }

        function animateBellNotation() {
            if (currentActiveDigitElement) {
                currentActiveDigitElement.classList.remove('active');
            }
            
            let lineDivToUpdate;
            let digitIndexToActivate = currentDigitIndex;

            if (currentDigitIndex >= plainHunt6[currentLineIndex].length) { 
                currentDigitIndex = 0;
                currentLineIndex++;
                if (currentLineIndex >= plainHunt6.length) {
                    currentLineIndex = 0;
                    leadCount++;
                    fibonacciIndex = (fibonacciIndex + 1) % fibonacciSequence.length;
                }
                if (bellNotationDisplay.children.length >= maxBellDisplayLines) {
                    bellNotationDisplay.removeChild(bellNotationDisplay.children[0]);
                }
                const newLine = document.createElement('div');
                newLine.classList.add('bell-line');
                const lineContent = plainHunt6[currentLineIndex];
                for (const digit of lineContent) {
                    const digitSpan = document.createElement('span');
                    digitSpan.classList.add('bell-digit');
                    digitSpan.textContent = digit;
                    newLine.appendChild(digitSpan);
                }
                bellNotationDisplay.appendChild(newLine);
                lineDivToUpdate = newLine; 
                digitIndexToActivate = 0; 
            } else {
                lineDivToUpdate = bellNotationDisplay.children[bellNotationDisplay.children.length - 1]; 
            }

            const digitSpanToActivate = lineDivToUpdate.children[digitIndexToActivate];
            if (digitSpanToActivate) {
                digitSpanToActivate.classList.add('active');
                currentActiveDigitElement = digitSpanToActivate; 
            }
            currentDigitIndex++;
            const delay = fibonacciSequence[fibonacciIndex] * baseBellSpeed;
            bellAnimationTimeout = setTimeout(animateBellNotation, delay);
        }

        function startPlayback(e) {
            if (e) e.preventDefault();
            
            if (ENABLE_SPATIAL_AUDIO) {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } else if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                // Update audio for all existing players
                videoPlayers.forEach(player => {
                    const left = parseFloat(player.container.style.left) || 0;
                    const top = parseFloat(player.container.style.top) || 0;
                    
                    // Determine dimensions again to pass correct limits
                    let limitX, limitY;
                    if (document.body.classList.contains('portrait')) {
                        limitX = (window.visualViewport ? window.visualViewport.height : window.innerHeight);
                        limitY = (window.visualViewport ? window.visualViewport.width : window.innerWidth);
                    } else {
                        limitX = window.innerWidth;
                        limitY = window.innerHeight;
                    }
                    
                    updateSpatialAudio(player.video, left, top, limitX, limitY);
                });
            }

            videoPlayers.forEach(player => player.video.play().catch(err => console.log(err)));
            if (audio) audio.play();

            isInitialLoad = false;
            introElements.style.display = 'none';
            animateBellNotation();
        }

        function checkOrientation() {
            if (window.matchMedia("(orientation: portrait)").matches) {
                document.body.classList.add('portrait');
            } else {
                document.body.classList.remove('portrait');
            }
        }

        // Init
        for (let i = 0; i < maxVideos; i++) createVideoPlayer();
        setupAudio();
        checkOrientation();
        initBellNotation();

        playSoundButton.addEventListener('click', startPlayback);
        reloadLink.addEventListener('click', (e) => { e.preventDefault(); location.reload(); });
        window.matchMedia("(orientation: portrait)").addEventListener("change", checkOrientation);

    </script>

</body>
</html>
